{% extends "base.html" %}
{% load static %}
{% block contents %}
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gi·ªè H√†ng</title>
    <link href="{% static 'app/css/cart_detail.css' %}" rel="stylesheet">
</head>
<body>
    <div class="container">
        <h1>Gi·ªè H√†ng c·ªßa B·∫°n</h1>
        <div id="cartItems"></div>  <!-- Ph·∫ßn t·ª≠ ch·ª©a c√°c item gi·ªè h√†ng -->
        <div class="total">
            T·ªïng s·ªë m·∫∑t h√†ng: <span id="totalItems">0</span>
            T·ªïng gi√°: <span id="totalPrice">0 VNƒê</span>
        </div>

        <div class="discount-section">
            <div class="voucher">
                <span class="voucher-icon">üéüÔ∏è</span>
                <span class="voucher-label">M√£ gi·∫£m gi√°</span>
                <input type="text" id="discountCode" placeholder="Nh·∫≠p m√£ gi·∫£m gi√°">
                <button onclick="applyDiscount()">√Åp d·ª•ng</button>
            </div>
            <div class="voucher-info">
                <span>Gi·∫£m 30.000 VNƒê cho ƒë∆°n h√†ng t·ª´ 150.000 VNƒê. T·ªëi ƒëa gi·∫£m 50.000 VNƒê.</span>
            </div>
        </div>

        <select id="shippingMethod" onchange="updateShippingCost()">
            <option value="standard">Giao h√†ng ti√™u chu·∫©n</option>
            <option value="express">Giao h√†ng nhanh</option>
        </select>
        <div id="shippingCost">Ph√≠ giao h√†ng: 0 VNƒê</div>
        <button class="button" onclick="openModal()">Thanh to√°n ngay</button>
    </div>

    <!-- Modal cho nh·∫≠p ƒë·ªãa ch·ªâ -->
    <div id="addressModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>ƒê·ªãa ch·ªâ m·ªõi</h2>
            <form id="addressForm">
                <label for="name">H·ªç v√† t√™n:</label>
                <input type="text" id="name" required placeholder="Nh·∫≠p h·ªç v√† t√™n">
                <label for="phone">S·ªë ƒëi·ªán tho·∫°i:</label>
                <input type="text" id="phone" required placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i">
                <label for="address">ƒê·ªãa ch·ªâ:</label>
                <input type="text" id="address" required placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ">
                <div class="button-container">
                    <button type="submit">Ho√†n th√†nh</button>
                    <button type="button" onclick="proceedToBuy()">Mua ngay</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let cart = JSON.parse(localStorage.getItem('cart')) || [];

        function renderCart() {
            const cartItemsContainer = document.getElementById('cartItems');
            cartItemsContainer.innerHTML = ''; // X√≥a n·ªôi dung c≈©

            if (cart.length === 0) {
                cartItemsContainer.innerHTML = `
                    <div class="empty-cart">
                        <a href="/shop">
                            <img src="https://maydongphucyte.com/default/template/img/cart-empty.png" alt="Gi·ªè h√†ng tr·ªëng" style="width: 300px; display: block; margin: 0 auto;">
                        </a>
                        <p>Gi·ªè h√†ng c·ªßa b·∫°n c√≤n tr·ªëng. Nh·∫•n v√†o ·∫£nh ƒë·ªÉ ƒëi ƒë·∫øn c·ª≠a h√†ng.</p>
                    </div>
                `;
                document.getElementById('totalPrice').textContent = '0 VNƒê';
                document.getElementById('totalItems').textContent = '0';
                return;
            }

            let totalPrice = 0;
            let totalItems = 0;
            cart.forEach((item, index) => {
                const cartItemDiv = document.createElement('div');
                cartItemDiv.classList.add('cart-item');
                cartItemDiv.innerHTML = `
                    <img src="${item.image}" alt="${item.name}">
                    <div class="item-details">
                        <h2>${item.name}</h2>
                        <p>${item.description}</p>
                        <label for="quantity-${index}">S·ªë l∆∞·ª£ng:</label>
                        <input type="number" id="quantity-${index}" value="${item.quantity}" min="1" style="width: 60px;" onchange="updateQuantity(${index})">
                        <button onclick="removeItem(${index})">X√≥a</button>
                    </div>
                    <div class="item-price">${(item.price * item.quantity).toLocaleString('vi-VN', { style: 'currency', currency: 'VND' })}</div>
                `;
                cartItemsContainer.appendChild(cartItemDiv);
                totalPrice += item.price * item.quantity;
                totalItems += item.quantity;
            });

            document.getElementById('totalPrice').textContent = totalPrice.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
            document.getElementById('totalItems').textContent = totalItems;
        }

        function updateQuantity(index) {
            const quantityInput = document.getElementById(`quantity-${index}`);
            cart[index].quantity = parseInt(quantityInput.value);
            localStorage.setItem('cart', JSON.stringify(cart));
            renderCart();
        }

        function removeItem(index) {
            cart.splice(index, 1);
            localStorage.setItem('cart', JSON.stringify(cart));
            renderCart();
        }

        function applyDiscount() {
            const discountCode = document.getElementById('discountCode').value;
            let discount = 0;
            const totalPriceElement = document.getElementById('totalPrice');
            const currentTotal = parseFloat(totalPriceElement.textContent.replace(/[^0-9]/g, ''));

            switch (discountCode) {
                case 'sale11/11':
                    discount = 30000; // Gi·∫£m 30.000 VNƒê
                    break;
                case 'quoctephunu20/10':
                    discount = 50000; // Gi·∫£m 50.000 VNƒê
                    break;
                case 'sale12/12':
                    discount = 10000; // Gi·∫£m 10.000 VNƒê
                    break;
                case 'khunggiovang':
                    discount = 20000; // Gi·∫£m 20.000 VNƒê
                    break;
                default:
                    alert("M√£ gi·∫£m gi√° kh√¥ng h·ª£p l·ªá.");
                    return;
            }

            const finalPrice = currentTotal - discount;
            totalPriceElement.textContent = finalPrice.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
            alert(`B·∫°n ƒë√£ ƒë∆∞·ª£c gi·∫£m ${discount / 1000} VNƒê!`);
        }

        function updateShippingCost() {
            const shippingMethod = document.getElementById('shippingMethod').value;
            let shippingCost = shippingMethod === 'express' ? 20000 : 0; // 20.000 VNƒê cho giao h√†ng nhanh
            document.getElementById('shippingCost').textContent = `Ph√≠ giao h√†ng: ${shippingCost.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' })}`;
        }

        function openModal() {
            document.getElementById('addressModal').style.display = "block";
        }

        function closeModal() {
            document.getElementById('addressModal').style.display = "none";
        }

        document.getElementById('addressForm').onsubmit = function(event) {
            event.preventDefault();
            const name = document.getElementById('name').value;
            const phone = document.getElementById('phone').value;
            const address = document.getElementById('address').value;

            alert(`ƒê·ªãa ch·ªâ ƒë√£ ƒë∆∞·ª£c l∆∞u!\nT√™n: ${name}\nSƒêT: ${phone}\nƒê·ªãa ch·ªâ: ${address}`);
            closeModal();
        };

        function proceedToBuy() {
            const name = document.getElementById('name').value;
            const phone = document.getElementById('phone').value;
            const address = document.getElementById('address').value;

            if (name && phone && address) {
                alert(`Ti·∫øn h√†nh mua h√†ng v·ªõi th√¥ng tin:\nT√™n: ${name}\nSƒêT: ${phone}\nƒê·ªãa ch·ªâ: ${address}`);
                closeModal();
            } else {
                alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin ƒë·ªãa ch·ªâ tr∆∞·ªõc khi mua.");
            }
        }

        renderCart();
    </script>
</body>
</html>
{% endblock contents %}